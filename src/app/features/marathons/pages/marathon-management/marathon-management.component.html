<div class="marathon-management">
  <div class="marathon-header">
    <h1>Gerenciar Maratonas</h1>
    <button class="btn btn-secondary" (click)="goToMovies()">
      Voltar para Filmes
    </button>
  </div>

  <!-- Current Marathon Section -->
  <div class="current-marathon-section">
    <div class="section-header">
      <h2>Maratona Atual</h2>
      <div class="marathon-controls">
        <button 
          class="btn btn-primary marathon-mode-btn" 
          [class.active]="isMarathonMode"
          (click)="toggleMarathonMode()">
          <span class="btn-text">{{ isMarathonMode ? 'Sair do Modo' : 'Modo Maratona' }}</span>
        </button>
        
        @if (isMarathonMode && currentMarathon.length > 0) {
          <button class="btn btn-success" (click)="openSaveModal()">
            Salvar Maratona
          </button>
          
          <button class="btn btn-danger" (click)="clearCurrentMarathon()">
            Limpar
          </button>
        }
      </div>
    </div>

    @if (!isMarathonMode) {
      <div class="marathon-mode-info">
        <p>Ative o "Modo Maratona" para começar a adicionar filmes à sua maratona atual.</p>
      </div>
    } @else if (currentMarathon.length === 0) {
      <div class="empty-marathon">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21,15 16,10 5,21"/>
        </svg>
        <h3>Maratona Vazia</h3>
        <p>Adicione filmes à sua maratona navegando pelos filmes e clicando em "Adicionar à Maratona".</p>
      </div>
    } @else {
      <div class="current-marathon-list">
        <div class="marathon-summary">
          <span class="movie-count">{{ currentMarathon.length }} filme{{ currentMarathon.length !== 1 ? 's' : '' }}</span>
          @if (currentMarathon.length > 0) {
            <span class="total-duration">
              Duração total: {{ getCurrentMarathonDuration() }}
            </span>
          }
        </div>
        
        <div class="movie-grid">
          @for (movie of currentMarathon; track movie.id) {
            <div class="movie-item">
              <img [src]="'https://image.tmdb.org/t/p/w200' + movie.poster_path" [alt]="movie.title" class="movie-poster">
              <div class="movie-info">
                <h4 class="movie-title">{{ movie.title }}</h4>
                <p class="movie-year">{{ movie.release_date | date:'yyyy' }}</p>
                <p class="movie-rating">⭐ {{ movie.vote_average }}</p>
              </div>
              <button class="remove-btn" (click)="removeFromCurrentMarathon(movie.id)" title="Remover da maratona">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
          }
        </div>
      </div>
    }
  </div>

  <!-- Saved Marathons Section -->
  <div class="saved-marathons-section">
    <h2>Maratonas Salvas</h2>
    
    @if (savedMarathons.length === 0) {
      <div class="empty-saved-marathons">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14,2 14,8 20,8"/>
          <line x1="16" y1="13" x2="8" y2="13"/>
          <line x1="16" y1="17" x2="8" y2="17"/>
          <polyline points="10,9 9,9 8,9"/>
        </svg>
        <h3>Nenhuma Maratona Salva</h3>
        <p>Crie sua primeira maratona adicionando filmes e salvando com um nome personalizado.</p>
      </div>
    } @else {
      <div class="marathons-grid">
        @for (marathon of savedMarathons; track marathon.id) {
          <div class="marathon-card">
            <div class="marathon-header-card">
              <h3 class="marathon-name">{{ marathon.name }}</h3>
              <div class="marathon-meta">
                <span class="movie-count">{{ marathon.movies.length }} filme{{ marathon.movies.length !== 1 ? 's' : '' }}</span>
                <span class="duration">{{ getMarathonDuration(marathon) }}</span>
              </div>
            </div>
            
            <div class="marathon-preview">
              @for (movie of marathon.movies.slice(0, 4); track movie.id) {
                <img [src]="'https://image.tmdb.org/t/p/w92' + movie.poster_path" [alt]="movie.title" class="preview-poster">
              }
              @if (marathon.movies.length > 4) {
                <div class="more-movies">+{{ marathon.movies.length - 4 }}</div>
              }
            </div>
            
            <div class="marathon-actions">
              <button class="btn btn-primary" (click)="loadMarathon(marathon)">
                Carregar
              </button>
              <button class="btn btn-secondary" (click)="startEditing(marathon)">
                Editar
              </button>
              <button class="btn btn-danger" (click)="confirmDelete(marathon)">
                Excluir
              </button>
            </div>
            
            <div class="marathon-date">
              Criado em: {{ formatDate(marathon.createdAt) }}
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Save Modal -->
  @if (showSaveModal) {
    <div class="modal-overlay" (click)="closeSaveModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Salvar Maratona</h3>
          <br>
          <button class="close-btn" (click)="closeSaveModal()">×</button>
        </div>
        <div class="modal-body">
          <p>Digite um nome para sua maratona:</p>
          <input 
            type="text" 
            [(ngModel)]="newMarathonName" 
            placeholder="Ex: Maratona do Oscar 2024"
            class="marathon-name-input"
            (keyup.enter)="saveMarathon()">
          <div class="marathon-preview-info">
            <p><strong>{{ currentMarathon.length }}</strong> filme{{ currentMarathon.length !== 1 ? 's' : '' }} • Duração: {{ getCurrentMarathonDuration() }}</p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeSaveModal()">Cancelar</button>
          <button class="btn btn-primary" (click)="saveMarathon()">Salvar Maratona</button>
        </div>
      </div>
    </div>
  }

  <!-- Delete Confirmation Modal -->
  @if (showDeleteModal && marathonToDelete) {
    <div class="modal-overlay" (click)="closeDeleteModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Confirmar Exclusão</h3>
          <button class="close-btn" (click)="closeDeleteModal()">×</button>
        </div>
        <div class="modal-body">
          <p>Tem certeza que deseja excluir a maratona <strong>"{{ marathonToDelete.name }}"</strong>?</p>
          <p class="warning-text">Esta ação não pode ser desfeita.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
          <button class="btn btn-danger" (click)="deleteMarathon()">Excluir</button>
        </div>
      </div>
    </div>
  }

  <!-- Edit Marathon Modal -->
  @if (showEditModal && editingMarathon) {
    <div class="modal-overlay" (click)="cancelEditing()">
      <div class="modal edit-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <button class="close-btn" (click)="cancelEditing()">×</button>
          <h3>Editar Maratona</h3>
        </div>
        <div class="modal-body">
          <div class="edit-form-section">
            <label for="editName">Nome da Maratona:</label>
            <input 
              type="text" 
              id="editName"
              [(ngModel)]="editMarathonName" 
              class="form-input"
              placeholder="Digite o nome da maratona">
          </div>
          
          <div class="movies-section">
            <div class="movies-header">
              <h4>Filmes da Maratona ({{ editingMovies.length }})</h4>
              <div class="sort-controls">
                <label for="sortBy">Ordenar por:</label>
                <select id="sortBy" [(ngModel)]="sortBy" (change)="onSortChange()" class="sort-select">
                  <option value="title">Nome (A-Z)</option>
                  <option value="release_date">Ano de Lançamento</option>
                  <option value="vote_average">Nota</option>
                  <option value="runtime">Duração</option>
                  <option value="popularity">Popularidade</option>
                </select>
                <select [(ngModel)]="sortOrder" (change)="onSortChange()" class="sort-order-select">
                  <option value="asc">Crescente</option>
                  <option value="desc">Decrescente</option>
                </select>
              </div>
            </div>
            <div class="movies-list">
              @for (movie of editingMovies; track movie.id; let i = $index) {
                <div class="movie-edit-item">
                  <img [src]="'https://image.tmdb.org/t/p/w92' + movie.poster_path" [alt]="movie.title" class="movie-poster">
                  <div class="movie-info">
                    <h5>{{ movie.title }}</h5>
                    <div class="movie-details">
                      <span class="movie-year">{{ movie.release_date ? movie.release_date.substring(0, 4) : 'N/A' }}</span>
                      <span class="movie-rating">⭐ {{ movie.vote_average.toFixed(1) }}</span>
                      <span class="movie-duration">{{ movie.runtime || 0 }}min</span>
                      <span class="movie-popularity">📊 {{ movie.popularity.toFixed(0) }}</span>
                    </div>
                  </div>
                  <div class="movie-actions">
                    <button class="btn btn-sm btn-secondary" (click)="moveMovieUp(i)" [disabled]="i === 0" title="Mover para cima">
                      ↑
                    </button>
                    <button class="btn btn-sm btn-secondary" (click)="moveMovieDown(i)" [disabled]="i === editingMovies.length - 1" title="Mover para baixo">
                      ↓
                    </button>
                    <button class="btn btn-sm btn-danger" (click)="removeMovieFromEdit(movie.id)" title="Remover filme">
                      ×
                    </button>
                  </div>
                </div>
              }
              @if (editingMovies.length === 0) {
                <p class="no-movies">Nenhum filme na maratona</p>
              }
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="cancelEditing()">
            Cancelar
          </button>
          <button class="btn btn-primary" (click)="saveEdit()">
            Salvar Alterações
          </button>
        </div>
      </div>
    </div>
  }
</div>
